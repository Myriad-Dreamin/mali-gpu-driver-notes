<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="generator" content="TiddlyWiki" />
<meta name="tiddlywiki-version" content="5.1.22" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="format-detection" content="telephone=no">
<link id="faviconLink" rel="shortcut icon" href="favicon.ico">
<link rel="stylesheet" href="static.css">
<title>KBase Device Driver IOCTL API Reference: Mali GPU Notes — some notes about mali gpu</title>
</head>
<body class="tc-body">

<section class="tc-story-river">
<p><div class="tc-tiddler-frame tc-tiddler-view-frame tc-tiddler-exists " data-tags="" data-tiddler-title="KBase Device Driver IOCTL API Reference"><div class="tc-tiddler-title"><div class="tc-titlebar"><span class="tc-tiddler-controls"><span class=" tc-reveal"><button aria-label="more" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fmore-tiddler-actions" title="More actions"></button><div class=" tc-reveal" hidden="true"></div></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal"><button aria-label="edit" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fedit" title="Edit this tiddler"></button></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal"><button aria-label="close" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fclose" title="Close this tiddler"></button></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span></span><span><span class="tc-tiddler-title-icon" style="fill:;"></span><h2 class="tc-title">KBase Device Driver IOCTL API Reference</h2></span></div><div class="tc-tiddler-info tc-popup-handle tc-reveal" hidden="true"></div></div><div class=" tc-reveal" hidden="true"></div>
<div class=" tc-reveal"><div class="tc-subtitle"><a class="tc-tiddlylink tc-tiddlylink-missing" href=".html"></a>11th September 2020 at 11:24pm</div></div><div class=" tc-reveal">
<div class="tc-tags-wrapper"></div>
</div>

<div class="tc-tiddler-body tc-reveal"><div><p>当File处于set up阶段时，只有以下两个api可用：</p>
<h3>kbase_api_handshake</h3>
<p>协商API版本，major以kernel中的值为主，否则minor取两者较小值。</p>
<p>从该API可以看出，每个以file生命周期为参考的session都有独立的<code>kbase_context</code>。</p>
<p>INOUT参数：</p>
<pre><code class="language-c"><span class="hljs-comment">/**
 * struct kbase_ioctl_version_check - Check version compatibility with kernel
 *
 * @major: Major version number
 * @minor: Minor version number
 */</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kbase_ioctl_version_check</span> {</span>
	__u16 major;
	__u16 minor;
};
</code></pre>
<h3>kbase_api_set_flags</h3>
<p>协商api特性参数。</p>
<pre><code class="language-c"><span class="hljs-comment">/**
 * struct kbase_ioctl_set_flags - Set kernel context creation flags
 *
 * @create_flags: Flags - see base_context_create_flags
 */</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kbase_ioctl_set_flags</span> {</span>
	__u32 create_flags;
};
</code></pre>
<p><code>create_flags</code>类型实际为下面说明：</p>
<pre><code class="language-c"><span class="hljs-comment">/**
 * typedef base_context_create_flags - Flags to pass to ::base_context_init.
 *
 * Flags can be ORed together to enable multiple things.
 *
 * These share the same space as BASEP_CONTEXT_FLAG_*, and so must
 * not collide with them.
 */</span>
<span class="hljs-keyword">typedef</span> u32 base_context_create_flags;
</code></pre>
<hr>
<p>当<code>kbase_context</code>创建以后，就可以开始正常API的调用。API调用的功能包括：</p>
<ul>
<li>
<p>给GPU派发工作</p>
</li>
<li>
<p>分配GPU内存</p>
</li>
</ul>
<h3>kbase_api_job_submit</h3>
<p>直接就调用了<code>kbase_jd_submit</code>, jd即Job Dispather的缩写。jd会将任务派发给js，即Job Scheduler，js会将任务交给jm，即Job Manager</p>
<p>入参如下：</p>
<pre><code class="language-c"><span class="hljs-comment">/**
 * struct kbase_ioctl_job_submit - Submit jobs/atoms to the kernel
 *
 * @addr: Memory address of an array of struct base_jd_atom_v2
 * @nr_atoms: Number of entries in the array
 * @stride: sizeof(struct base_jd_atom_v2)
 */</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kbase_ioctl_job_submit</span> {</span>
	__u64 addr;
	__u32 nr_atoms;
	__u32 stride;
};
</code></pre>
<p><code>kbase_jd_submit</code>的描述如下：</p>
<pre><code class="language-c"><span class="hljs-comment">/**
 * kbase_jd_submit - Submit atoms to the job dispatcher
 *
 * @kctx: The kbase context to submit to
 * @user_addr: The address in user space of the struct base_jd_atom_v2 array
 * @nr_atoms: The number of atoms in the array
 * @stride: sizeof(struct base_jd_atom_v2)
 * @uk6_atom: true if the atoms are legacy atoms (struct base_jd_atom_v2_uk6)
 *
 * Return: 0 on success or error code
 */</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">kbase_jd_submit</span><span class="hljs-params">(struct kbase_context *kctx,
		<span class="hljs-keyword">void</span> __user *user_addr, u32 nr_atoms, u32 stride,
		<span class="hljs-keyword">bool</span> uk6_atom)</span></span>;
</code></pre>
<h3>kbase_api_mem_alloc</h3>
<p>分配一块足够大的GPU内存，虚拟地址由GPU确定，大小按页对齐。内存管理的特性满足配置<code>base_mem_alloc_flags</code>。一旦分配，是否能够修改根据<code>BASEP_MEM_FLAGS_KERNEL_ONLY</code>确定，即使有这个也可以在内核态中修改。</p>
<pre><code class="language-c"><span class="hljs-comment">/**
 * union kbase_ioctl_mem_alloc - Allocate memory on the GPU
 *
 * @va_pages: The number of pages of virtual address space to reserve
 * @commit_pages: The number of physical pages to allocate
 * @extent: The number of extra pages to allocate on each GPU fault which grows
 *          the region
 * @flags: Flags
 * @gpu_va: The GPU virtual address which is allocated
 *
 * @in: Input parameters
 * @out: Output parameters
 */</span>
<span class="hljs-keyword">union</span> kbase_ioctl_mem_alloc {
	<span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
		__u64 va_pages;
		__u64 commit_pages;
		__u64 extent;
		__u64 flags;
	} in;
	<span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
		__u64 flags;
		__u64 gpu_va;
	} out;
};
</code></pre>
<blockquote>
<p>todo, mem flags analysis</p>
</blockquote>
<pre><code class="language-c"></code></pre>
</div></div>



</div>

</p>
</section>
</body>
</html>
