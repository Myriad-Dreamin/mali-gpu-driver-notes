<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="generator" content="TiddlyWiki" />
<meta name="tiddlywiki-version" content="5.1.22" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="format-detection" content="telephone=no">
<link id="faviconLink" rel="shortcut icon" href="favicon.ico">
<link rel="stylesheet" href="static.css">
<title>Bifrost KBase Platform Driver: Mali GPU Notes — some notes about mali gpu</title>
</head>
<body class="tc-body">

<section class="tc-story-river">
<p><div class="tc-tiddler-frame tc-tiddler-view-frame tc-tiddler-exists " data-tags="" data-tiddler-title="Bifrost KBase Platform Driver"><div class="tc-tiddler-title"><div class="tc-titlebar"><span class="tc-tiddler-controls"><span class=" tc-reveal"><button aria-label="more" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fmore-tiddler-actions" title="More actions"></button><div class=" tc-reveal" hidden="true"></div></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal"><button aria-label="edit" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fedit" title="Edit this tiddler"></button></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal"><button aria-label="close" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fclose" title="Close this tiddler"></button></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span></span><span><span class="tc-tiddler-title-icon" style="fill:;"></span><h2 class="tc-title">Bifrost KBase Platform Driver</h2></span></div><div class="tc-tiddler-info tc-popup-handle tc-reveal" hidden="true"></div></div><div class=" tc-reveal" hidden="true"></div>
<div class=" tc-reveal"><div class="tc-subtitle"><a class="tc-tiddlylink tc-tiddlylink-missing" href=".html"></a>20th August 2020 at 8:41pm</div></div><div class=" tc-reveal">
<div class="tc-tags-wrapper"></div>
</div>

<div class="tc-tiddler-body tc-reveal"><div><h4>io_resource</h4>
<p>Resources are put in fixed order: I/O memory region, job IRQ, MMU IRQ, GPU IRQ.</p>
<p>在11.21版本中，如果你在<code>drivers/gpu/arm/midgard/platform/Kconfig</code>中添加的是<code>drivers/gpu/arm/midgard/platform/vexpress/Kconfig</code>，那么应用的配置如下：</p>
<ul>
<li>register map: 映射到<code>0xFC010000</code>往后16KB大小的内存空间 (<code>0xFC010000</code>~<code>0xFC014000</code>)</li>
<li>job, mmu, gpu IRQ号分别为68, 69, 70</li>
</ul>
<pre><code class="language-c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">kbasep_config_parse_io_resources</span><span class="hljs-params">(<span class="hljs-keyword">const</span> struct kbase_io_resources *io_resources, struct resource *<span class="hljs-keyword">const</span> linux_resources)</span>
</span>{
	...
	linux_resources[<span class="hljs-number">0</span>].flags = IORESOURCE_MEM;
	...
	linux_resources[<span class="hljs-number">1</span>].flags = IORESOURCE_IRQ | IORESOURCE_IRQ_HIGHLEVEL;
	...
	linux_resources[<span class="hljs-number">2</span>].flags = IORESOURCE_IRQ | IORESOURCE_IRQ_HIGHLEVEL;
	...
	linux_resources[<span class="hljs-number">3</span>].flags = IORESOURCE_IRQ | IORESOURCE_IRQ_HIGHLEVEL;
}
</code></pre>
<h4>kbase_platform_driver.probe (kbase_platform_device_probe)</h4>
<p>为<code>kbdev</code>分配<code>kbase_device</code>大小的内存，分配特征为<code>GFP_KERNEL</code></p>
<p>使用<code>dev_set_drvdata</code>将<code>kbdev</code>附着到linux自带的<code>device</code>的上下文中，同时可以通过<code>dev_get_drvdata</code>重新获取<code>kbdev</code>指针。这个<code>device</code>来自于kbase的platform_device。</p>
<p>同时使用<code>kbase_device_init</code>初始化<code>kbdev</code>。</p>
<p>初始化函数分阶段存储在数组<code>dev_init</code>中，类型为<code>kbase_device_init[]</code>。</p>
<p>在11.21版本中，init列表如下，如有兴趣了解，请前往对应页面查看初始化过程：</p>
<pre><code class="language-c"><span class="hljs-comment">/**
 * struct kbase_device_init - Device init/term methods.
 * @init: Function pointer to a initialise method.
 * @term: Function pointer to a terminate method.
 * @err_mes: Error message to be printed when init method fails.
 */</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kbase_device_init</span> {</span>
	kbase_device_init_method *init;
	kbase_device_term_method *term;
	<span class="hljs-keyword">char</span> *err_mes;
};

<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kbase_device_init</span> <span class="hljs-title">dev_init</span>[] = {</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> CONFIG_MALI_NO_MALI</span>
	{kbase_gpu_device_create, kbase_gpu_device_destroy,
			<span class="hljs-string">"Dummy model initialization failed"</span>},
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
	{assign_irqs, <span class="hljs-literal">NULL</span>,
			<span class="hljs-string">"IRQ search failed"</span>},
	{registers_map, registers_unmap,
			<span class="hljs-string">"Register map failed"</span>},
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
	{kbase_device_io_history_init, kbase_device_io_history_term,
			<span class="hljs-string">"Register access history initialization failed"</span>},
	{kbase_device_pm_init, kbase_device_pm_term,
			<span class="hljs-string">"Power management initialization failed"</span>},
	{kbase_device_early_init, kbase_device_early_term,
			<span class="hljs-string">"Early device initialization failed"</span>},
	{kbase_device_populate_max_freq, <span class="hljs-literal">NULL</span>,
			<span class="hljs-string">"Populating max frequency failed"</span>},
	{kbase_device_misc_init, kbase_device_misc_term,
			<span class="hljs-string">"Miscellaneous device initialization failed"</span>},
	{kbase_ctx_sched_init, kbase_ctx_sched_term,
			<span class="hljs-string">"Context scheduler initialization failed"</span>},
	{kbase_mem_init, kbase_mem_term,
			<span class="hljs-string">"Memory subsystem initialization failed"</span>},
	{kbase_device_coherency_init, <span class="hljs-literal">NULL</span>,
			<span class="hljs-string">"Device coherency init failed"</span>},
	{kbase_protected_mode_init, kbase_protected_mode_term,
			<span class="hljs-string">"Protected mode subsystem initialization failed"</span>},
	{kbase_device_list_init, kbase_device_list_term,
			<span class="hljs-string">"Device list setup failed"</span>},
	{kbasep_js_devdata_init, kbasep_js_devdata_term,
			<span class="hljs-string">"Job JS devdata initialization failed"</span>},
	{kbase_device_timeline_init, kbase_device_timeline_term,
			<span class="hljs-string">"Timeline stream initialization failed"</span>},
	{kbase_device_hwcnt_backend_gpu_init,
			kbase_device_hwcnt_backend_gpu_term,
			<span class="hljs-string">"GPU hwcnt backend creation failed"</span>},
	{kbase_device_hwcnt_context_init, kbase_device_hwcnt_context_term,
			<span class="hljs-string">"GPU hwcnt context initialization failed"</span>},
	{kbase_device_hwcnt_virtualizer_init,
			kbase_device_hwcnt_virtualizer_term,
			<span class="hljs-string">"GPU hwcnt virtualizer initialization failed"</span>},
	{kbase_device_vinstr_init, kbase_device_vinstr_term,
			<span class="hljs-string">"Virtual instrumentation initialization failed"</span>},
	{kbase_backend_late_init, kbase_backend_late_term,
			<span class="hljs-string">"Late backend initialization failed"</span>},
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> MALI_KBASE_BUILD</span>
	{kbase_debug_job_fault_dev_init, kbase_debug_job_fault_dev_term,
			<span class="hljs-string">"Job fault debug initialization failed"</span>},
	{kbase_device_debugfs_init, kbase_device_debugfs_term,
			<span class="hljs-string">"DebugFS initialization failed"</span>},
	<span class="hljs-comment">/* Sysfs init needs to happen before registering the device with
	 * misc_register(), otherwise it causes a race condition between
	 * registering the device and a uevent event being generated for
	 * userspace, causing udev rules to run which might expect certain
	 * sysfs attributes present. As a result of the race condition
	 * we avoid, some Mali sysfs entries may have appeared to udev
	 * to not exist.
	 * For more information, see
	 * https://www.kernel.org/doc/Documentation/driver-model/device.txt, the
	 * paragraph that starts with "Word of warning", currently the
	 * second-last paragraph.
	 */</span>
	{kbase_sysfs_init, kbase_sysfs_term, <span class="hljs-string">"SysFS group creation failed"</span>},
	{kbase_device_misc_register, kbase_device_misc_deregister,
			<span class="hljs-string">"Misc device registration failed"</span>},
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> CONFIG_MALI_BUSLOG</span>
	{buslog_init, buslog_term, <span class="hljs-string">"Bus log client registration failed"</span>},
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
	{kbase_gpuprops_populate_user_buffer, kbase_gpuprops_free_user_buffer,
			<span class="hljs-string">"GPU property population failed"</span>},
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
	{kbase_dummy_job_wa_load, kbase_dummy_job_wa_cleanup,
			<span class="hljs-string">"Dummy job workaround load failed"</span>},
};
</code></pre>
<h4>kbase_platform_driver.remove (kbase_platform_device_remove)</h4>
<h4>kbase_platform_driver.pm.suspend (kbase_device_suspend)</h4>
<h4>kbase_platform_driver.pm.resume (kbase_device_resume)</h4>
<h4>kbase_platform_driver.pm.runtime_suspend (kbase_device_runtime_suspend)</h4>
<h4>kbase_platform_driver.pm.runtime_resume (kbase_device_runtime_resume)</h4>
<h4>kbase_platform_driver.pm.runtime_idle (kbase_device_runtime_idle)</h4>
</div></div>



</div>

</p>
</section>
</body>
</html>
